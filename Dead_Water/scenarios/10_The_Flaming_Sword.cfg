#textdomain wesnoth-deadwater

# You defeat the lich to try to get the sword, but as soon as the lich drops it, Caladon teleports in and picks it up. Now, you need to defeat Caladon to get the sword. He grants you time to leave, which is actually a turn to remove any very damaged units from the vicinity as Caladon is pretty dangerous. You can attack him now, or wait a turn for him to get impatient and attack you. When he attacks, or you attack him, he summons fire guardians (stolen from UtBS). He does not also recruit, because that would just be mean. (There is no reason he would have much gold anyway.)

[scenario]
    name= _ "The Flaming Sword"
    map_data="{@campaigns/Dead_Water/maps/The_Flaming_Sword.map}"

    id=The_Flaming_Sword
    next_scenario=Getting_Help

    [story]
        [part]
            story= _ "Caladon lead them just a little way up the shore. They were still on the outskirts of the swamp, and despite its name, the swamp wasn't that desolate here. Many hardy people were scraping a living out of the damp soil."
        [/part]

        [part]
            background=Background_Map.jpg
            show_title=yes
            {CROSS_WHITE_CENTERED 746 673}
            {DOT_WHITE_CENTERED 729 657}
            {DOT_WHITE_CENTERED 734 635}
            {CROSS_WHITE_CENTERED 732 615}
            {DOT_WHITE_CENTERED 708 612}
            {DOT_WHITE_CENTERED 681 607}
            {DOT_WHITE_CENTERED 654 600}
            {DOT_WHITE_CENTERED 647 573}
            {DOT_WHITE_CENTERED 640 546}
            {CROSS_WHITE_CENTERED 650 522}
            {DOT_WHITE_CENTERED 637 497}
            {DOT_WHITE_CENTERED 628 473}
            {DOT_WHITE_CENTERED 610 454}
            {DOT_WHITE_CENTERED 589 437}
            {DOT_WHITE_CENTERED 576 412}
            {DOT_WHITE_CENTERED 575 388}
            {DOT_WHITE_CENTERED 552 381}
            {CROSS_WHITE_CENTERED 542 361}
            {DOT_WHITE_CENTERED 523 370}
            {DOT_WHITE_CENTERED 501 381}
            {DOT_WHITE_CENTERED 477 391}
            {CROSS_WHITE_CENTERED 455 401}
            {DOT_WHITE_CENTERED 434 414}
            {DOT_WHITE_CENTERED 414 428}
            {CROSS_WHITE_CENTERED 395 446}
            {DOT_WHITE_CENTERED 402 471}
            {DOT_WHITE_CENTERED 396 495}
            {DOT_WHITE_CENTERED 387 518}
            {DOT_WHITE_CENTERED 369 537}
            {DOT_WHITE_CENTERED 344 548}
            {DOT_WHITE_CENTERED 319 542}
            {DOT_WHITE_CENTERED 307 523}
            {FLAG_WHITE_CENTERED 306 497}
            {DOT_WHITE_CENTERED 286 479}
            {DOT_WHITE_CENTERED 265 467}
            {DOT_WHITE_CENTERED 266 444}
            {DOT_WHITE_CENTERED 279 424}
            {DOT_WHITE_CENTERED 301 413}
            {DOT_WHITE_CENTERED 321 399}
            {DOT_WHITE_CENTERED 339 378}
            {DOT_WHITE_CENTERED 354 356}
            {DOT_WHITE_CENTERED 368 334}
            {DOT_WHITE_CENTERED 384 315}
            {DOT_WHITE_CENTERED 395 293}
            {DOT_WHITE_CENTERED 375 278}
            {DOT_WHITE_CENTERED 357 264}
            {CROSS_WHITE_CENTERED 355 242}
            {DOT_CENTERED 346 222}
            {DOT_CENTERED 357 203}
            {DOT_CENTERED 374 191}
            {DOT_CENTERED 386 175}
            {CROSS_CENTERED 373 160}
        [/part]
    [/story]

    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    {DAWN}
    {MORNING}
    {AFTERNOON}

    {TURNS4 30 28 26 24}
    victory_when_enemies_defeated=no
    {VICTORY_AND_DEFEAT_MUSIC}

    [side]
        {SIDE_1}
        {GOLD4 150 100 100 100}
    [/side]

    [side]
        side=2
        controller=ai
        type=Lich
        description=Mal Govon
        user_description=Mal Govon
        canrecruit=yes

        user_team_name=Mal Govon
        team_name=bad guys

        # The first turn, I want the lich to recruit fairly weak scouts to get villages. That way he'll have more gold for strong units on the next turns--units to use to attack. There is an event that gives him all the rest of his recruits on a later turn. If I don't do this, he uses all his money for a few Spectres and has no income left. There aren't enough units to beat the player, even though they are strong ones.
        recruit="Blood Bat, Ghost"
        [ai]
            recruitment_pattern=fighter,fighter,archer,scout,scout,scout
            # Ignoring these two makes for a more interesting variety of enemies:
            recruitment_ignore_bad_combat=yes
            recruitment_ignore_bad_movement=yes
            scout_village_targetting=5
            [protect_location]
                x,y=36,23
                radius=8
                value=200
            [/protect_location]
        [/ai]

        {INCOME4 15 20 25 30}
        {GOLD4 500 550 600 650}
    [/side]

    {STARTING_VILLAGES 2 5}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Blood Bat) 5}

    [side]
        side=3
        no_leader=yes
        village_value=0
        team_name=good guys
        user_team_name=Villagers
    [/side]

    [side]
        side=4
        no_leader=yes
        village_value=0
        description=Caladon
        user_description=Caladon
        team_name=Caladon
        user_team_name=Caladon
        income=-2
        gold=0
        controller=null
    [/side]

    [event]
        name=turn 2

        [allow_recruit]
            side=2
#ifdef EASY
            type="Blood Bat, Ghost, Wraith, Spectre, Shadow, Bone Shooter, Deathblade, Revenant, Ghoul, Necrophage"
#endif

#ifdef NORMAL
            type="Blood Bat, Ghost, Wraith, Spectre, Shadow, Nightgaunt, Bone Shooter, Deathblade, Ghoul, Necrophage, Choccobone"
#endif

#ifdef HARD
            type="Blood Bat, Ghost, Wraith, Spectre, Shadow, Nightgaunt, Bone Shooter, Banebow, Deathblade, Ghoul, Necrophage, Choccobone"
#endif

#ifdef NIGHTMARE
            type="Blood Bat, Ghost, Wraith, Spectre, Shadow, Nightgaunt, Bone Shooter, Banebow, Deathblade, Ghoul, Necrophage, Choccobone"
#endif
        [/allow_recruit]

#ifdef EASY
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Wraith) 4}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Shadow) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Spectre) 2}
#endif
#ifdef NORMAL
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Wraith) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Spectre) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Shadow) 4}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Nightgaunt) 2}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Bone Shooter) 3}
#endif
#ifdef HARD
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Wraith) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Spectre) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Nightgaunt) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Bone Shooter) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Shadow) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Banebow) 2}
#endif
#ifdef NIGHTMARE
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Wraith) 5}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Spectre) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Shadow) 6}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Nightgaunt) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Bone Shooter) 3}
        {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Banebow) 2}
#endif
    [/event]

    [event]
        name=prestart

        [music]
            name=the_city_falls.ogg
        [/music]

        {RECALL_LOYAL_UNITS}

        [objectives]
            side=1
            [objective]
                description= _ "Pry the flaming sword from the dead hand of its owner"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Kai Krellis"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Cylanna"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Caladon"
                condition=lose
            [/objective]
            [objective]
                description= _ "Run out of Turns"
                condition=lose
            [/objective]
        [/objectives]

        # Hide lich for now:
        [hide_unit]
            x=37
            y=3
        [/hide_unit]

        [role]
            side=1
            race=merman
            type=Mermaid Siren, Merman Entangler, Mermaid Diviner, Mermaid Enchantress, Merman Netcaster, Mermaid Priestess, Merman Brawler, Mermaid Initiate, Merman Javelineer, Merman Spearman, Merman Hunter, Merman Citizen
            role=spy
        [/role]
        [recall]
            roll=spy
        [/recall]
        [store_unit]
            variable=spy_unit
            role=spy
        [/store_unit]
        [modify_side]
            side=1
            income=$spy_unit.level # Since you have little gold, and maybe you didn't want to recall this unit, it is free. You're welcome.
        [/modify_side]

        {VARIABLE sword_x 999}
        {VARIABLE sword_y 999}

        # This is where the lich starts, so he will pick up this object immediately:
        {FLAMING_SWORD 37 3 flaming-sword1}

        [recall]
            description=Caladon
            x,y=8,27
        [/recall]
    [/event]

    [event]
        name=start

        [message]
            speaker=$spy_unit.description
            message= _ "(whispered) Kai, I heard Caladon muttering about the sword. I think he may try to take it for himself."
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "(whispered) Thank you $spy_unit.user_description|. I will keep that in mind, but it may be hard for us to stop him with that teleporting trick he has."
        [/message]

        [message]
            speaker=Caladon
            message= _ "Here we are. See that castle in the distance? That's where Agnovon has the sword."
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "The lich is Agnovon?"
        [/message]
        [message]
            speaker=Caladon
            message= _ "Well, he calls himself Mal Govon now, but yes. He called this land the KINGDOM of Agnovon. He was its first king. And its last, and every one in between, too! He kept getting older and older, but he never died. Well, NOW he's dead of course. He still putters around in that castle over there, but he hasn't really cared about keeping his kingdom under control for a good long while. I bet I can wake him up, though. Watch THIS!"
        [/message]
        [message]
            speaker=narrator
            message= _ "All the merfolk clamped their hands over their ears as Caladon's strident voice got much louder than any of them would have believed to be possible."
            image=wesnoth-icon.png
        [/message]
        [message]
            speaker=Caladon
            message= _ "AGNOVON, I'VE COME FOR YOUR SWORD! TODAY YOU WILL REMEMBER FEAR! Heh heh."
        [/message]

        [scroll_to]
            x=37
            y=3
        [/scroll_to]
        [unhide_unit]
        [/unhide_unit]
        [redraw]
        [/redraw]

        [message]
            speaker=narrator
            message= _ "A voice came back like wind moaning through dry leaves. Though it was only whispered, they all heard it better than they wanted."
            image=wesnoth-icon.png
        [/message]
        [message]
            speaker=Mal Govon
            message= _ "What I remember, you old fool, is you leaving behind the smouldering bodies of the orcs you had brought to try to take my sword. Now, you bring mermen. When they lay expiring like gasping fish on the shore, will you not flee again? Do not speak to me of fear."
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "We are here of our own accord, and we will take that sword."
        [/message]
        [message]
            speaker=Mal Govon
            message= _ "The merman speaks. Tell it to go away, Caladon, if it doesn't want to get hurt."
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "That does it. Attack!"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            description=Caladon
            side=1
        [/filter]

        [message]
            speaker=Caladon
            message= _ "A word of warning, young Kai. I carry a Staff of RIGHTEOUS Flame. If you let me die, I will take YOU all with me!"
            duration=50
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            [filter_location]
                x=17
                y=19
                radius=3
            [/filter_location]
            side=1
        [/filter]

        [unit]
            type=Trapper
            side=3
            x=17
            y=19
            description=Howyrth
            user_description=Howyrth
            ai_special=guardian
        [/unit]
        [delay]
            time=500
        [/delay]

        [message]
            speaker=Howyrth
            message= _ "Hello there! Who are you? Were you the ones shouting about taking a sword?"
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "I am Kai Krellis of Jotha. I am attempting to defeat Mal Govon and take his sword. Would you like to join us in battle against a common enemy?"
        [/message]

        [message]
            speaker=Howyrth
            message= _ "I don't know if that creature is really our enemy. He has never bothered us, and I have to stay here and guard the area anyway. However, I'm sure many townsfolk would be happy of the extra income if you want to hire them to help you fight. I guess we would be happy to get rid of the monster just in case."
        [/message]
        [message]
            speaker=narrator
            message= _ "You can now recruit human villagers, but you will not be able to recall them in future scenarios."
            image=wesnoth-icon.png
        [/message]

        [allow_recruit]
            type=Poacher, Thug, Footpad, Peasant, Woodsman
            side=1
        [/allow_recruit]

        [if]
            [variable]
                name=Siddry_stored
                not_equals=no
            [/variable]
            [then]
                [move_unit_fake]
                    type=$Siddry_stored.type
                    side=1
                    x=23, 18
                    y=14, 17
                [/move_unit_fake]
                [set_variable]
                    name=Siddry_stored.x
                    value=18
                [/set_variable]
                [set_variable]
                    name=Siddry_stored.y
                    value=17
                [/set_variable]
                # Siddry may have been stored low on hitpoints, and after moving and attacking, so we'll fix all that now:
                [set_variable]
                    name=Siddry_stored.hitpoints
                    value=37	#Hard coded because he is resillient and max_hitpoints is too low
                [/set_variable]
                [set_variable]
                    name=Siddry_stored.moves
                    value=$Siddry_stored.max_moves
                [/set_variable]
                [set_variable]
                    name=Siddry_stored.attacks_left
                    value=$Siddry_stored.max_attacks
                [/set_variable]
                [unstore_unit]
                    variable=Siddry_stored
                [/unstore_unit]
                [message]
                    speaker=Siddry
                    message= _ "Kai Krellis! What are you doing here? I thought you were travelling south when I met you."
                [/message]
                [message]
                    speaker=Kai Krellis
                    message= _ "Friend Siddry!"
                [/message]
                [message]
                    speaker=Howyrth
                    message= _ "You know each other?!"
                [/message]
                [message]
                    speaker=Siddry
                    message= _ "Kai Krellis is the one who saved me from slavery, Howyrth. I told him I would repay him if I could, and here is my chance. My friends and I will join you in your fight, Kai Krellis. We are yours to command until you have your sword."
                [/message]
                [unit]
                    type=Footpad
                    x=18
                    y=18
                    side=1
                    gender=female
                    description=Lyllan
                    user_description=Lyllan
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_DEXTROUS}
                    [/modifications]
                    overlays=overlays/loyal-icon.png
                [/unit]
                [unit]
                    type=Thug
                    x=18
                    y=18
                    side=1
                    description=Trudd
                    user_description=Trudd
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_RESILIENT}
                    [/modifications]
                    overlays=overlays/loyal-icon.png
                [/unit]
                [unit]
                    type=Thug
                    x=18
                    y=18
                    side=1
                    description=Dorcyn
                    user_description=Dorcyn
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_QUICK}
                    [/modifications]
                    overlays=overlays/loyal-icon.png
                [/unit]

                {CLEAR_VARIABLE Siddry_stored}
            [/then]
        [/if]
    [/event]

    # The variable "Caladon_leader_status" can be one of several values:
    # <empty>:	 Caladon is not a leader. He is still a unit on side 1
    # "passive":   His side still has "controller=null" set. (He is giving the mermen time to leave before attacking them.)
    # "impatient": Brillan's side now has "controller=ai" set. (He's tired of waiting for the mermen to leave.) This is actually *set* on the players turn, because Caladon's side doesn't *get* a turn until it is set. On his first turn after "impatient" is set, he will say something and summon fire guardians.
    # "angry":	 Player attacked Caladon. (...and Caladon summoned the first fire guardians immediately, so he no longer has to on his turn.)
    # "leader":	He is a normal leader now. He has started his turns, and is summoning two fire guardians per turn.
    # "dead":	  Keeps any of the other events from happening.

#define ACTIVATE_CALADON
    [store_unit]
        [filter]
            description=Caladon
        [/filter]
        kill=yes
        variable=Caladon_stored
    [/store_unit]

    [unstore_unit]
        variable=Caladon_stored
    [/unstore_unit]

    [modify_side]
        side=4
        controller=ai
    [/modify_side]
#enddef

#define SUMMON_FIRE_GUARDIANS NUMBER
    {REPEAT {NUMBER} (
    [unit]
        type=Fire Guardian
        [store_unit]
            [filter]
                description=Caladon
            [/filter]
            variable=Caladon_stored
        [/store_unit]
        # The guardians are summond on Caladon's position, so they will surround him or surround his attackers if there are any:
        x=$Caladon_stored.x
        y=$Caladon_stored.y
        side=4
        animate=yes
        generate_description=yes
    [/unit]
    )}
#enddef

    [event]
        name=die
        [filter]
            description=Mal Govon
        [/filter]

        # It seems strange to have to kill him in a "die" event, but he's only *mostly* dead otherwise, and Caladon can't teleport to his location:
        [kill]
            description=Mal Govon
        [/kill]

        {PLACE_IMAGE items/flame-sword.png $x1 $y1}
        [delay]
            time=600
            # Gives you half a second to see the sword before the message (probably) covers it up.
        [/delay]

        [if]
            [variable]
                name=second_unit.description
                equals=Kai Krellis
            [/variable]
            [then]
                {VARIABLE staff_tip_off Cylanna}
            [/then]
            [else]
                {VARIABLE staff_tip_off second_unit}
            [/else]
        [/if]

        [message]
            speaker=second_unit
            message= _ "Now we have the sword!"
        [/message]

        [message]
            speaker=Caladon
            message= _ "Correction. Now I have the sword!"
        [/message]

        [store_unit]
            [filter]
                description=Caladon
            [/filter]
            variable=Caladon_stored
        [/store_unit]

        [remove_unit_overlay]
            x=$Caladon_stored.x
            y=$Caladon_stored.y
            image=misc/hero-icon.png
        [/remove_unit_overlay]

        [store_unit]
            [filter]
                description=Caladon
            [/filter]
            kill=yes
            variable=Caladon_stored
        [/store_unit]

        {VARIABLE Caladon_stored.side 4}
        {VARIABLE Caladon_stored.canrecruit yes}
        # He is not going to recruit, but summon guardians each turn. Still, he needs this variable set to get a crown icon, and to show up in the status table.

        [unstore_unit]
            variable=Caladon_stored
        [/unstore_unit]

        [animate_unit]
            flag=pre_teleport
        [/animate_unit]

        [teleport]
            [filter]
                description=Caladon
            [/filter]
            x=$x1
            y=$y1
        [/teleport]

        [animate_unit]
            flag=post_teleport
        [/animate_unit]

        # Remove the death of Caladon from a the loss conditions
        [objectives]
            silent=yes
            side=1
            [objective]
                description= _ "Pry the flaming sword from the dead hand of its owner"
                condition=win
            [/objective]
            {HOW_TO_LOSE}
        [/objectives]

        [delay]
            time=700
            # Gives you time to see that Caladon teleported to the sword before the message (probably) covers him up (because he will be near the top of the screen).
        [/delay]

        {FLAMING_SWORD $x1 $y1 flaming-sword2}
        [object]
            id=drop_staff
            silent=yes
            [filter]
                x=$x1
                y=$y1
            [/filter]
            [effect]
                apply_to=remove_attacks
                name=staff
            [/effect]
        [/object]

        [message]
            speaker=Caladon
            message= _ "It's MINE! The Flaming Sword of Agnovon IS ALL MINE! I can feel warmth SPREADING through me!"
        [/message]

        [object]
            id=healer
            silent=yes
            [filter]
                x=$x1
                y=$y1
            [/filter]
            [effect]
                apply_to=hitpoints
                heal_full=yes
            [/effect]
        [/object]
        [sound]
            name=heal.wav
        [/sound]
        [delay]
            time=400
            # Wait for the sound to play (mostly) until scrolling to Kai Krellis
        [/delay]

        [message]
            speaker=Kai Krellis
            message= _ "What? We won that sword!"
        [/message]

        [message]
            speaker=Caladon
            message= _ "Well, it's true that you helped, so I won't kill you. But I don't trust you, so leave my realm. Go on. I will grant you some time. The benevolence of Caladon will be LEGENDARY! Heh heh, HA!"
        [/message]

        [message]
            speaker=$staff_tip_off
            message= _ "(whispered) Kai! He dropped his righteous flame staff! We can attack him now!"
        [/message]
        {VARIABLE Caladon_leader_status passive}
        # see note above on this variable
    [/event]

    [event]
        name=attack
        first_time_only=no

        [filter]
            side=1
        [/filter]
        [filter_second]
            side=4
        [/filter_second]

        [if]
            [variable]
                name=Caladon_leader_status	# see note above
                equals=passive
            [/variable]
            [or]
                [variable]
                    name=Caladon_leader_status
                    equals=impatient
                [/variable]
            [/or]
            [then]
                {ACTIVATE_CALADON}
                [message]
                    speaker=Caladon
                    message= _ "You DARE attack ME! You will regret that. Witness the POWER of the Flaming Sword of Caladon! I call on the ELEMENT OF FIRE to DO MY BIDDING!"
                [/message]
                {SUMMON_FIRE_GUARDIANS 6}
                {VARIABLE Caladon_leader_status leader}
            [/then]
        [/if]
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [if]
            [variable]
                name=side_number
                equals=1
            [/variable]
            [and]
                [variable]
                    name=Caladon_leader_status	# see note above
                    equals=passive
                [/variable]
            [/and]

            [then]
                {ACTIVATE_CALADON}
                {VARIABLE Caladon_leader_status impatient}
            [/then]
        [/if]
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [if]
            [variable]
                name=side_number
                equals=4
            [/variable]
            [and]
                [variable]
                    name=Caladon_leader_status	# see note above
                    not_equals=dead
                [/variable]
            [/and]
            [then]
                [if]
                    [variable]
                        name=Caladon_leader_status
                        equals=leader
                    [/variable]

                    [then]
                        {SUMMON_FIRE_GUARDIANS 2}
                    [/then]
                [/if]

                [if]
                    [variable]
                        name=Caladon_leader_status
                        equals=impatient
                    [/variable]

                    [then]
                        [message]
                            speaker=Caladon
                            message= _ "You aren't leaving yet. My patience is at an END! Witness the POWER of the Flaming Sword of Caladon! I call on the ELEMENT OF FIRE to DO MY BIDDING!"
                        [/message]
                        {SUMMON_FIRE_GUARDIANS 6}
                        {VARIABLE Caladon_leader_status leader}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            description=Caladon
            side=1
        [/filter]

        [sound]
            name=lightning.ogg
        [/sound]
        [sound]
            name=rumble.ogg
        [/sound]

        [kill]
            [filter]
            [/filter]
        [/kill]

        {VARIABLE color 250}
        {VARIABLE delta 8}
        {REPEAT 14 (
        [set_variable]
            name=delta
            add=-3
        [/set_variable]

        [set_variable]
            name=color
            add=$delta
        [/set_variable]

        [colour_adjust]
            red,green,blue=$color|,$color|,$color
        [/colour_adjust]

        [delay]
            time=100
        [/delay]
        )}

        [colour_adjust]
            red,green,blue=0,0,0
        [/colour_adjust]
    [/event]

    [event]
        name=die
        [filter]
            description=Caladon
            side=4
        [/filter]

        [set_variable]
            name=sword_x
            value=$x1
        [/set_variable]
        [set_variable]
            name=sword_y
            value=$y1
        [/set_variable]

        {PLACE_IMAGE items/flame-sword.png $sword_x $sword_y}
        [delay]
            time=600
            # Gives you half a second to see the sword before the message (probably) covers it up (because it will be near the top of the screen).
        [/delay]

        [message]
            speaker=Kai Krellis
            message= _ "Now we can finally grab that sword."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x=$sword_x
            y=$sword_y
            side=1
            race=human
        [/filter]

        [message]
            speaker=unit
            message= _ "I am not going with you. One of you should take the sword."
        [/message]
    [/event]

    # The first_time_only moveto causes the sword's attacks to be explained. The moved unit gets the option to take it.
    # If the unit takes it, a sword *object* is put on the hex, and the unit gets it because he is standing there already.
    # If the unit does not take it, another moveto event is added. This one is *not* first_time_only, but it does the same thing.
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x=$sword_x
            y=$sword_y
            side=1
            [not]
                race=human
            [/not]
        [/filter]

        [message]
            speaker=narrator
            message= _ "This sword is 8-4, magical, with 'fire' damage.  (It does 8 damage on each of 4 swings, with a 70% chance to hit.)"
            image=wesnoth-icon.png
        [/message]

        [message]
            speaker=unit
            [option]
                message= _ "I'll carry this sword, but I don't know how to summon fire demons."
                [command]
                    [set_variable]
                        name=get_sword
                        value=yes
                    [/set_variable]
                [/command]
            [/option]
            [option]
                message= _ "This sword is not right for me. Let someone else have it."
            [/option]
        [/message]

        [if]
            [variable]
                name=get_sword
                equals=yes
            [/variable]
            [then]
                {FLAMING_SWORD $sword_x $sword_y flaming-sword3}
                {CLEAR_VARIABLE get_sword}
                {CLEAR_VARIABLE spy_unit}
                [endlevel]
                    result=victory
                [/endlevel]
            [/then]
            [else]
                [event]
                    name=moveto
                    first_time_only=no
                    [allow_undo]
                    [/allow_undo]
                    [filter]
                        x=$sword_x
                        y=$sword_y
                        side=1
                    [/filter]

                    [message]
                        speaker=unit
                        [option]
                            message= _ "I'll carry this sword, but I don't know how to summon fire demons."
                            [command]
                                [set_variable]
                                    name=get_sword
                                    value=yes
                                [/set_variable]
                            [/command]
                        [/option]
                        [option]
                            message= _ "This sword is not right for me. Let someone else have it."
                        [/option]
                    [/message]
                    [if]
                        [variable]
                            name=get_sword
                            equals=yes
                        [/variable]
                        [then]
                            {FLAMING_SWORD $sword_x $sword_y flaming-sword3}
                            {CLEAR_VARIABLE get_sword}
                            [endlevel]
                                result=victory
                            [/endlevel]
                        [/then]
                    [/if]
                [/event]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory
        [if]
            [have_unit]
                race=human
                side=1
            [/have_unit]
            [then]
                [message]
                    speaker=Kai Krellis
                    message= _ "We thank all you humans for your help, and release you from any farther obligations. Where we are going, you cannot easily follow."
                [/message]
                [kill]
                    race=human
                [/kill]
            [/then]
        [/if]

        [disallow_recruit]
            type=Poacher, Thug, Footpad, Peasant, Woodsman
            side=1
        [/disallow_recruit]

        {CLEAR_VARIABLE Caladon_stored}
        {CLEAR_VARIABLE sword_x}
        {CLEAR_VARIABLE sword_y}
    [/event]

    [event]
        name=die
        [filter]
            description=Cylanna
        [/filter]
        [message]
            speaker=Kai Krellis
            message= _ "Cylanna! I need you!"
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "Tyegëa will never forgive me. We are lost."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            description=Kai Krellis
        [/filter]
        [message]
            speaker=Cylanna
            message= _ "We are lost without our leader!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Last breath events for Caladon: It doesn't seem possible to make the LAST_BREATH macro handle a filter, but I need to check for two conditions: the unit's name *and* it's side (if it's Caladon). I'll use this event instead of that macro. (Why not just use the "last breath" event? Check the note on the LAST_BREATH macro in utils.)
    [event]
        name=attack_end
        first_time_only=no

        [store_unit]
            variable=Caladon_stored
            [filter]
                description=Caladon
            [/filter]
        [/store_unit]

        [if]
            [variable]
                name=Caladon_stored.hitpoints
                less_than_equal_to=0
            [/variable]
            [then]
                [if]
                    [variable]
                        name=Caladon_stored.side
                        equals=1
                    [/variable]
                    [then]
                        [message]
                            speaker=Caladon
                            message= _ "Aghh! Die!"
                        [/message]

                        [message]
                            speaker=Kai Krellis
                            message= _ "He has that staff of..."
                        [/message]
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=Caladon_stored.side
                        equals=4
                    [/variable]
                    [then]
                        [message]
                            speaker=Caladon
                            message= _ "CURSE you mermen!"
                        [/message]

                        [message]
                            speaker=$spy_unit.description
                            message= _ "What a lunatic!"
                        [/message]
                        {VARIABLE Caladon_leader_status dead}
                    [/then]
                [/if]
            [/then]
        [/if]
        [clear_variable]
            name=Caladon_stored
        [/clear_variable]
    [/event]
[/scenario]
