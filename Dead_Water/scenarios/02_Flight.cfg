#textdomain wesnoth-deadwater

# Hopefully Kai Krellis is at least half leveled up already. Otherwise, this can be painful. Recruit a buch of citizens and brawlers, and send them east with Krellis. Use citizens to lure the skeleton archer types into the water. They are easy pickings there for other citizens, brawlers, and Krellis. One of those guys gets Krellis half way up to level one. A few citizens should also survive to become brawlers. About the time you get Krellis leveled up, and you are thinking about retreating everyone else, the bats will arrive. Use hunters and initiates to clear a path back west. Send three or four expendable units with Krellis. Their job is only to keep him from getting stuck in a ZOC. Krellis runs for the corner, while the rest of the troops gain experience doing a fighting retreat from the skeletons, and other bad guys arriving in the middle of the map. Ignore gold for now. You don't need much on the next level.

# Killing all the enemy leaders will end the level, but I doubt that possible except on easy. Even then it will be a challenge I think.

# If one of the named enemies is killed, a variable is stored. That way, the same names won't get used in the last level.

[scenario]
    name= _ "Flight"
    map_data="{@campaigns/Dead_Water/maps/Home_2.map}"

    id=Flight
    next_scenario=Wolf_Coast

    [story]
        [part]
            story= _ "Kai Krellis was concerned that the undead might return, so he decided to learn as much as possible about them. The necromancer had mentioned a 'Lord Ravanal', so that seemed like a good place to start. He sent messengers north and south along the coast to see if they could find out about Ravanal. The news he heard was not good."
        [/part]

        [part]
            story= _ "Mal-Ravanal was a wizard from the east who had turned himself into a lich. He had attacked the edges of Wesnoth, and was building a fearsome army of undead humans there. He had also sent necromancers to attack the orcs, and even the elves, in a quest for undead soldiers of different races. It seemed that he also wanted merfolk. There was little doubt that Kai Krellis' people would be attacked again."
        [/part]

        [part]
            story= _ "As the weeks went by, the veterans of the last battle helped train new recruits. Krellis' army did not yet match his father's, but he now had many competent soldiers. As he had expected, their adversaries soon returned."
        [/part]

        [part]
            background=Background_Map.jpg
            show_title=yes
            {CROSS_WHITE_CENTERED 746 673}
            {CROSS_CENTERED 746 673}
        [/part]
    [/story]

    {DEFAULT_SCHEDULE}
    {TURNS4 22 20 18 18}
    {VICTORY_AND_DEFEAT_MUSIC}
    victory_when_enemies_defeated=no

    [side]
        {SIDE_1}
        {GOLD4 120 100 80 60}
    [/side]

    {STARTING_VILLAGES 1 6}

    [event]
        name=prestart

        [music]
            name=nunc_dimittis.ogg
        [/music]
        [music]
            name=elvish-theme.ogg
            append=yes
        [/music]

        {RECALL_LOYAL_UNITS}

        [objectives]
            side=1
            [objective]
                description= _ "Move Kai Krellis to the north-west corner of the map. He must be level one or higher."
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat the enemy leaders (Good luck.)"
                condition=win
            [/objective]
            {HOW_TO_LOSE}
        [/objectives]
    [/event]

    [side]
        side=2
        controller=ai
        user_team_name= _ "Mal-Ravanal's Forces"
        team_name=bad guys
        colour=teal

        type=Lich
        description=Mal Kevek
        user_description=Mal Kevek
        canrecruit=yes
        [ai]
        	recruitment_pattern=scout, scout, scout, scout, scout, fighter
            [avoid]
                x=43,43,43,43,43,42,42,41,41,41,40,39,38,37,36,35,33,32
                y=13,14,15,16,17,17,18,19,20,21,22,24,25,26,26,27,27,27
            [/avoid]
		[/ai]
		
#ifdef EASY
        recruit="Vampire Bat, Ghost, Ghoul, Wraith, Necrophage"
#endif

#ifdef NORMAL
        recruit="Vampire Bat, Ghost, Ghoul, Wraith, Necrophage"
#endif

#ifdef HARD
        recruit="Vampire Bat, Blood Bat, Ghost, Ghoul, Wraith, Shadow, Necrophage"
#endif

#ifdef NIGHTMARE
        recruit="Vampire Bat, Blood Bat, Ghost, Ghoul, Wraith, Shadow, Necrophage, Spectre"
#endif

        {GOLD4 180 210 320 450}
        {INCOME4 4 8 10 14}
    [/side]

    [side]
        side=3
        controller=ai
        user_team_name= _ "Mal-Ravanal's Forces"
        team_name=bad guys
        colour=orange

        type=Necromancer
        description=Mel Daveth
        user_description=Mel Daveth
        canrecruit=yes

#ifdef EASY
        recruit="Zombie Swimmer, Vampire Bat"
#endif

#ifdef NORMAL
        recruit="Zombie Swimmer, Souless Swimmer, Vampire Bat, Blood Bat"
#endif

#ifdef HARD
        recruit="Zombie Swimmer, Soulless Swimmer, Vampire Bat, Blood Bat"
#endif

#ifdef NIGHTMARE
        recruit="Zombie Swimmer, Soulless Swimmer, Vampire Bat, Blood Bat"
#endif

        {GOLD4 120 160 220 300}
        {INCOME4 8 10 14 16}
    [/side]

    [side]
        side=4
        controller=ai
        user_team_name= _ "Mal-Ravanal's Forces"
        team_name=bad guys
        colour=white

        type=Death Knight
        description=Dead Knight
        canrecruit=yes
        [ai]
        	recruitment_pattern=fighter, archer
		[/ai]
		
#ifdef EASY
        recruit="Vampire Bat, Skeleton Archer, Skeleton, Bone Shooter, Revenant"
#endif

#ifdef NORMAL
        recruit="Vampire Bat, Skeleton Archer, Skeleton, Bone Shooter, Deathblade"
#endif

#ifdef HARD
        recruit="Vampire Bat, Chocobone, Skeleton Archer, Skeleton, Bone Shooter, Deathblade"
#endif

#ifdef NIGHTMARE
        recruit="Vampire Bat, Chocobone, Skeleton Archer, Skeleton, Bone Shooter, Deathblade, Banebow"
#endif

        {GOLD4 180 220 320 450}
        {INCOME4 4 8 10 14}
    [/side]

    # I want more, not more powerful, units. Limit the level twos so the leaders have to buy more level ones
    # The ifdefs are neccessary because this macro will allow recruits that weren't originally in the recruit lists
#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Bone Shooter) 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Revenant 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Necrophage 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Wraith 2}
#endif
#ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Bone Shooter) 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Deathblade 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Wraith 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Necrophage 2}
#endif
#ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Spectre 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Wraith 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Shadow 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Chocobone 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Bone Shooter) 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Deathblade 2}
#endif
#ifdef NIGHTMARE
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Chocobone 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 (Bone Shooter) 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Deathblade 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Banebow 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Spectre 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Wraith 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 Shadow 3}
#endif



    [event]
        name=start

        [message]
            speaker=Mal Kevek
            message= _ "You may have ended my first life, but you have only made me more powerful. Now I will teach you a lesson!"
        [/message]

        [message]
            speaker=Mel Daveth
            message= _ "Leave some of them for me."
        [/message]

        [message]
            speaker=Dead Knight
            message= _ "Uhhh."
        [/message]

        [message]
            speaker=Mel Daveth
            message= _ "And him."
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "We are surrounded. Look how many there are! How can we defeat them this time?"
        [/message]

        [message]
            speaker=Cylanna
            message= _ "I'm afraid we cannot. We need help. My old instructor, Tyegëa, teaches on an island to the North. She and her priestesses are powerful. With their help we could probably defeat these enemies. We just have to convince her to leave her enclave."
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "You can do that, right?"
        [/message]

        [message]
            speaker=Cylanna
            message= _ "I do not believe I can. However, you could."
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "Me? I've never even met Tyegëa. How can I convince her to help us if you cannot?"
        [/message]

        [message]
            speaker=Cylanna
            message= _ "You will just have to trust me on this. She will listen to you. I will say no more on the matter."
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "Very well. How do we get there?"
        [/message]

        [message]
            speaker=Cylanna
            message= _ "We follow the coast north, then go west to Bilheld Island. Tyegëa lives on a small island to the west of Bilheld."
        [/message]

        [message]
            speaker=Kai Krellis
            message= _ "That will take many days. I cannot leave my people here to be slaughtered by undead monsters while we go for help."
        [/message]

        [message]
            speaker=Cylanna
            message= _ "Of course not. They will all have to come with us."
        [/message]

        [store_unit]
            [filter]
                description=Kai Krellis
            [/filter]
            variable=KK
        [/store_unit]

        # We'll discuss why KK needs to level up, but only if he is not already at level one or higher
        [if]
            [variable]
                name=KK.level
                numerical_equals=0
            [/variable]
            [then]
                [if]
                    [have_unit]
                        description=Gwabbo
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Gwabbo
                            message= _ "We are not all soldiers used to obeying orders. I am afraid that not everyone will follow you on so strange an adventure. First you must prove you are not afraid of danger. If you leave now, many will think you are simply running away to save yourself."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Cylanna
                            message= _ "However, I am afraid that not everyone will follow you on so strange an adventure. First you must prove you are not afraid of danger. If you leave now, many will think you are simply running away to save yourself."
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Kai Krellis
                    message= _ "My people will see me fight the undead before we leave, even if beating them all is impossible."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Kai Krellis
                    message= _ "But will everyone follow me on so strange an adventure? Maybe they will not trust me."
                [/message]
                [if]
                    [have_unit]
                        description=Gwabbo
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Gwabbo
                            message= _ "I believe the people will follow you. Since you have already proven your courage in battle, they will understand that you would not leave if there was any other choice."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Cylanna
                            message= _ "I believe they will follow you. Since you have already proven your courage in battle, they will understand that you would not leave if there were any other choice."
                        [/message]
                    [/else]
                [/if]
            [/else]
        [/if]

        [clear_variable]
            name=KK
        [/clear_variable]
    [/event]

	[event]
		# I don't use the macro for the speed ring here so that the unit doesn't get an overlay.
		name=prestart
		
        [object]
            id=speed_ring1
            silent=yes

            [effect]
                apply_to=movement
                increase=1
            [/effect]

            [filter]
                description=Mal Kevek
            [/filter]
        [/object]
        
        [set_variable]
        	name=ring_x
        	value=999
        [/set_variable]
        
        [set_variable]
        	name=ring_y
        	value=999
        [/set_variable]
	[/event]

    {LAST_BREATH (Mal Kevek) (
    [message]
        speaker=Mal Kevek
        message= _ "This is impossible!"
    [/message]
    )}

    [event]
        name=die
        [filter]
            description=Mal Kevek
        [/filter]
		
		[set_variable]
            name=ring_x
            value=$x1
        [/set_variable]
        [set_variable]
            name=ring_y
            value=$y1
        [/set_variable]

        {PLACE_IMAGE items/ring-silver.png $ring_x $ring_y}
        [delay]
            time=600
            # Gives you half a second to see the ring before the message (probably) covers it up (because it will be near the top of the screen).
        [/delay]
        
        [message]
        	speaker=$second_unit.description
        	message= _ "The undead human was wearing a ring! Maybe it is magic. Someone should try it on to see what it does."
        [/message]
        
    # If either of the named characters is dead, take note because they shouldn't show up in the last scenario. (We'll just rename the bad guys in that case.)
        [set_variable]
        	name=MK_dead
            value=yes
        [/set_variable]
    [/event]
    
	[event]
		name=moveto
		first_time_only=no
		
		[filter]
			x=$ring_x
			y=$ring_y
			side=1
		[/filter]
		
		[if]
			[variable]
				name=unit.description
				equals=Friendly Bat
			[/variable]
			[then]
				[if]
					[variable]
						name=seen_ring_description
						not_equals=yes
					[/variable]
					[then]
						[message]
							speaker=narrator
							message= _ "The bat slips the ring over a claw, and begins flapping like a demented hummingbird!"
						[/message]
				
						[message]
							speaker=narrator
							message= _ "This ring gives its owner one more movement point."
							image=wesnoth-icon.png
						[/message]
						
						[set_variable]
							name=seen_ring_description
							value=yes
						[/set_variable]
					[/then]
				[/if]
		
				[message]
					speaker=Kai Krellis
					[option]
						message= _ "We will let the bat have the ring. It will make him even more helpful."
						[command]
							[set_variable]
								name=get_ring
								value=yes
							[/set_variable]
						[/command]
					[/option]
					[option]
						message= _ "Someone take that off of him before he hurts himself."
					[/option]
				[/message]
			[/then]
			
			[else]
				[if]
					[variable]
						name=seen_ring_description
						not_equals=yes
					[/variable]
					[then]
						[message]
							speaker=unit
							message= _ "I'll try on the ring."
						[/message]
						
						[message]
							speaker=unit
							message= _ "I feel different. I feel like I can go from one end of the bay and back without tiring!"
						[/message]
						
						[message]
							speaker=narrator
							message= _ "This ring gives its owner one more movement point."
							image=wesnoth-icon.png
						[/message]
						[set_variable]
							name=seen_ring_description
							value=yes
						[/set_variable]
					[/then]
				[/if]
		
				[message]
					speaker=unit
					[option]
						message= _ "I'll take this ring, and you can rely on my quickness."
						[command]
							[set_variable]
								name=get_ring
								value=yes
							[/set_variable]
						[/command]
					[/option]
					[option]
						message= _ "This ring makes me dizzy. Someone else can have it."
					[/option]
				[/message]
			[/else]
		[/if]

		[if]
			[variable]
				name=get_ring
				equals=yes
			[/variable]
			[then]
				{SPEED_RING $ring_x $ring_y speed-ring2}
				{CLEAR_VARIABLE get_ring}
				{CLEAR_VARIABLE seen_ring_description}
				[set_variable]
					name=ring_x
					value=999
				[/set_variable]
			[/then]
			[else]
				[allow_undo][/allow_undo]
			[/else]
		[/if]
	[/event]
		
    [event]
        name=die
        [filter]
            description=Mel Daveth
        [/filter]

        # It seems strange to have to kill him in a "die" event, but he's only *mostly* dead otherwise, and the bat can't appear at his location:
        [kill]
            description=Mel Daveth
        [/kill]
        
         [unit]
        	type=Vampire Bat
        	side=1
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            description=Friendly Bat
            user_description= _ "Friendly Bat"
            unrenamable=no
            side=1
            x=$x1
            y=$y1
            overlays=overlays/loyal-icon.png
        [/unit]
        
        [if]
        	[variable]
        		name=$second_unit.description
        		not_equals=Kai Krellis
        	[/variable]
        	[then]
        		[message]
        			speaker=second_unit
		        	message= _ "Look! There is a bat cowering in the corner here."
        		[/message]
        		[message]
        			speaker=Kai Krellis
		        	message= _ "Well, kill it, and lets keep moving."
        		[/message]
        		[message]
        			speaker=second_unit
		        	message= _ "But look, it's licking my hand."
        		[/message]
        		[message]
        			speaker=Friendly Bat
		        	message= _ "Neep?"  # This should just be "translated" to whatever noise a bat makes in your language.
        		[/message]
        		[message]
        			speaker=second_unit
		        	message= _ "It's kind of cute."
        		[/message]
           		[message]
        			speaker=Kai Krellis
		        	message= _ "Alright then. I suppose we have our own bat."
        		[/message]
        	[/then]
        	[else]
        		[message]
        			speaker=second_unit
		        	message= _ "Look! There is a bat cowering in the corner here."
        		[/message]
        		[message]
        			speaker=Cylanna
		        	message= _ "Aren't you going to kill it? We need to keep moving."
        		[/message]
        		[message]
        			speaker=second_unit
		        	message= _ "I would feel bad about that. It is, uh, licking my hand."
        		[/message]
        		[message]
        			speaker=Friendly Bat
		        	message= _ "Neep?"
        		[/message]
        		[message]
        			speaker=Cylanna
		        	message= _ "Apparently you have your own bat."
        		[/message]
        	[/else]
        [/if]

        [set_variable]
        	name=MD_dead
            value=yes
        [/set_variable]
    [/event]
    
    [event]
        name=die

        [filter]
            description=Dead Knight
        [/filter]

# The chest looks funny if it's floating on top of the Death Knight's tent, so we'll put it at the second unit's feet (or tail)
        [item]
            x=$second_unit.x
            y=$second_unit.y
            image=items/chest.png
        [/item]
        [message]
            speaker=second_unit
            message= _ "Look, this chest was in his tent. It is filled with gold!"
        [/message]
        [sound]
            name=gold.ogg
        [/sound]
        [gold]
            side=1
            amount=120
        [/gold]
        [message]
        	speaker=narration
        	image=wesnoth-icon.png
        	message= _ "You recieve 120 gold."
		[/message]
    [/event]

    # Win if KK gets to the corner
    [event]
        name=moveto
        first_time_only=no

        [allow_undo]
        [/allow_undo]

        [filter]
            x=1
            y=1
            description=Kai Krellis
        [/filter]

        [store_unit]
            [filter]
                description=Kai Krellis
            [/filter]
            variable=KK
        [/store_unit]

        [if]
            [variable]
                name=KK.level
                greater_than=0
            [/variable]
            [then]
                [message]
                    speaker=Kai Krellis
                    message= _ "I hate to leave our home, but we will return."
                [/message]

				[clear_variable]
					name=ring_x
				[/clear_variable]
				[clear_variable]
					name=ring_y
				[/clear_variable]
                
                [endlevel]
                    result=victory
                    bonus=yes
                [/endlevel]
            [/then]
        [/if]
    [/event]

    # This event triggers a win if Kai Krellis advances while already sitting on the target hex
    [event]
        name=post_advance
        first_time_only=no

        [filter]
            x=1
            y=1
            description=Kai Krellis
        [/filter]

        [message]
            speaker=Kai Krellis
            message= _ "I hate to leave our home, but we will return."
        [/message]

        [endlevel]
            result=victory
            bonus=yes
        [/endlevel]
    [/event]

    [event]
        name=enemies defeated
        [message]
            speaker=Cylanna
            message= _ "Killing these enemies was good, but more will be coming. We still need to leave."
        [/message]
        [message]
            speaker=Kai Krellis
            message= _ "I hate to leave our home, but we will return."
        [/message]
		
		[clear_variable]
			name=ring_x
		[/clear_variable]
		[clear_variable]
			name=ring_y
		[/clear_variable]
        
        [endlevel]
            result=victory
            bonus=yes
        [/endlevel]
    [/event]

    {HERO_DEATHS}
[/scenario]
